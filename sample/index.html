<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sample AirTable Submit</title>
    <link rel="icon" href="data:," />
    <!-- State Template CDN CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.cdt.ca.gov/cdt/statetemplate/6.3.0/css/cagov.core.min.css"
      integrity="sha256-dhlQXqYtHrg7UE7IEYYcdTf2GFAr3gm/pmhgDoThjMk="
      crossorigin="anonymous" />
    <script
      src="https://cdn.cdt.ca.gov/cdt/statetemplate/6.3.0/js/cagov.core.min.js"
      integrity="sha256-Ly4XaH2v22Z05t7R0/hMrs42s+hscO5tHTbAa5oDC78="
      crossorigin="anonymous"></script>
  </head>

  <body>
    <script src="https://www.google.com/recaptcha/api.js" defer></script>
    <script>
      // const serviceUrl = "https://api.template.webstandards.ca.gov/api/air-table";
      const serviceUrl = "http://localhost:12345/api/air-table";

      const siteKey = "6Lcf3GYjAAAAAGPae1QeEf0jJ8xjTwrwPAHOhZIJ"; // Set this to your recaptch site key
    </script>

    <div id="main-content" class="main-content">
      <div class="container p-t-md p-b-lg">
        <h1 class="m-t-0">Contact us</h1>
        <p>
          Have a question? Contact us for help with general inquiries, feedback,
          or bugs.
        </p>
        <div class="row">
          <div class="col-lg-8">
            <form
              autocomplete="on"
              method="POST"
              id="ContactUsForm"
              role="form">
              <div
                class="alert alert-danger alert-banner brd-0 brd-red p-l m-t-md"
                role="alert">
                <span
                  class="alert-icon ca-gov-icon-warning-diamond color-red"
                  aria-hidden="true"></span>
                <div class="container m-l-md">
                  <span class="alert-text gray-900 font-weight-600">
                    Correct the errors to continue
                  </span>
                </div>
              </div>
              <label class="form-control-label m-t-md" for="InputName">
                Your name
                <span class="required-label" aria-hidden="true">*</span>
              </label>
              <input
                autofocus
                type="text"
                class="form-control rounded-5"
                id="InputName"
                name="Name"
                autocomplete="name"
                required
                aria-required="true"
                size="65"
                maxlength="150"
                minlength="1"
                role="textbox" />
              <div class="mt-2 invalid-feedback font-weight-600 d-block">
                Enter your name
              </div>

              <label class="form-control-label m-t-lg" for="InputEmail">
                Email
                <span class="required-label" aria-hidden="true">*</span>
              </label>
              <input
                type="email"
                class="form-control rounded-5"
                id="InputEmail"
                name="Email"
                autocomplete="email"
                required
                aria-required="true"
                size="65"
                maxlength="250"
                minlength="1"
                role="textbox" />
              <div class="mt-2 invalid-feedback font-weight-600 d-block">
                Enter a valid email. Example: name@email.com
              </div>

              <label class="form-control-label  m-t-lg" for="InputDepartment">
                Department or agency
              </label>
              <input
                type="text"
                class="form-control rounded-5"
                id="InputDepartment"
                name="Department"
                autocomplete="organization"
                aria-required="false"
                size="65"
                maxlength="150"
                minlength="1"
                role="textbox" />

              <label class="form-control-label  m-t-lg" for="InputRole">
                Main role
              </label>

              <select
                class="form-select form-select-lg mb-3"
                id="InputRole"
                name="Role">
                <option value="">Select an option</option>
                <option value="Analytics">Analytics</option>
                <option value="Content">Content</option>
                <option value="Design">Design</option>
                <option value="Development">Development</option>
                <option value="Product">Product</option>
                <option value="Program">Program</option>
                <option value="Research">Research</option>
                <option value="Other">Other</option>
              </select>

              <label class="form-control-label  m-t-lg" for="InputComments">
                How can we help?
                <span class="required-label" aria-hidden="true">*</span>
              </label>
              <textarea
                id="InputComments"
                class="form-control rounded-5"
                rows="5"
                cols="80"
                name="Comments"
                aria-required="true"
                required
                maxlength="100000"
                minlength="10"
                role="textbox"></textarea>
              <div class="mt-2 invalid-feedback font-weight-600 d-block">
                Provide information about why you're contacting us.
              </div>

              <input
                type="submit"
                value="Submit"
                class="btn btn-primary m-t-lg" />

              <button
                class="g-recaptcha hidden"
                data-sitekey=""
                data-callback="recaptchaCallback"
                data-action="submit"></button>
            </form>
          </div>
        </div>

        <h2>Get support from developers</h2>
        <p>
          Post questions on
          <a href="https://github.com/Office-of-Digital-Services/">
            <span class="sr-only">Digital Services</span>
            GitHub
          </a>
          and leverage our digital community.
        </p>

        <h2>Technical feedback</h2>
        <p>
          To provide State Web Template V6 code level feedback, visit our
          <a
            href="https://github.com/Office-of-Digital-Services/California-State-Web-Template-Development">
            State Web Template GitHub Development Repo
          </a>
          .
        </p>

        <h2>Subscribe to our network</h2>
        <p>
          Join our community of digital teams and share your own best practices.
          From product managers to content designers, the
          <a href="https://cdt.ca.gov/dwsn/">Digital Web Services Network</a>
          offers a collaborative space for all members of state digital teams.
        </p>

        <style type="text/css">
          form:not(form[submit_attempted]) .form-control+.invalid-feedback,
          form:not(form[submit_attempted]) .alert,
          form:valid .alert,
          .form-control:valid+.invalid-feedback {
            display: none !important;
          }


          /* new */

          .invalid-feedback {
            position: relative;
          }

          .invalid-feedback::before {
            content: "\ea2f";
            position: absolute;
            font-family: "CaGov";
            font-size: 1.5rem;
            right: 10px;
            top: -51px;
          }

          form[submit_attempted] .alert {
            border-left: 5px solid;
          }

          form[submit_attempted] .alert .container {
            padding-top: 2px;
          }

          form[submit_attempted] .form-control:invalid {
            border-bottom: 4px solid #cd402d;
            position: relative;
          }



          .error-icon {
            display: none;
            float: right;
            position: relative;
            top: -2.7rem !important;
            right: 10px;
            font-size: 1.5rem;
          }

          form[submit_attempted] .form-control:invalid~.error-icon {
            display: block;
          }

          .form-control[role="combobox"]::placeholder {
            font-size: 1.1rem !important;
          }

          /* masking combobox carrot */
          .combobox::before {
            content: "\33";
            position: absolute;
            font-family: "CaGov";
            font-size: 1.4rem;
            width: 30px;
            height: 30px;
            background-color: white;
            right: 5px;
            top: 8px;
          }
        </style>

        <div class="modal fade" id="modalResponse" role="dialog" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h3 class="h4 modal-title">Problem with submission.</h3>
                <button
                  type="button"
                  class="close btn btn-secondary"
                  data-bs-dismiss="modal">
                  <span class="sr-only">Close modal</span>
                  <span
                    class="ca-gov-icon-close-mark"
                    aria-hidden="true"></span>
                </button>
              </div>
              <div class="modal-body">
                There was a problem with your submission. Please wait a moment
                and try again.
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-default"
                  data-bs-dismiss="modal">
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <button
      type="button"
      id="btnModal"
      class="hidden"
      data-bs-toggle="modal"
      data-bs-target="#modalResponse"></button>
    <a
      href="contact-us-thankyou.html"
      id="urlThankyou"
      class="hidden"
      rel="noindex"></a>

    <script>
      document.querySelector("button.g-recaptcha").dataset.sitekey = siteKey;

      window.addEventListener("load", () => {

        getForm().addEventListener("submit", submitForm);
        getSubmitButton().addEventListener("click", () =>
          getForm().setAttribute("submit_attempted", "")
        );
      });



      function getForm() {
        return /** @type {HTMLFormElement} */ (
          document.getElementById("ContactUsForm")
        );
      }

      function getSubmitButton() {
        return /** @type { HTMLButtonElement } */ (
          getForm().querySelector("input[type=submit]")
        );
      }

      function goToThanksPage() {
        document.getElementById("urlThankyou").click();
      }

      function openModal() {
        document.getElementById("btnModal").click();
      }

      function triggerRecaptcha() {
        document.querySelector(".g-recaptcha").click(); //will trigger recaptchaCallback when complete
      }

      async function submitForm(/** @type { SubmitEvent } */ e) {
        e.preventDefault();

        getSubmitButton().disabled = true;
        setTimeout(() => (getSubmitButton().disabled = false), 5000);

        triggerRecaptcha();
      }

      function recaptchaCallback(/** @type { string } */ g_recaptcha_response) {
        const postBody = {
          captcha: { "g-recaptcha-response": g_recaptcha_response },
          fields: {},
        };

        for (const pair of new FormData(getForm())) {
          postBody.fields[pair[0]] = pair[1];
        }

        delete postBody.fields["g-recaptcha-response"]; //we already have it from the callback

        /** @type { RequestInit } */
        const request = {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(postBody),
        };

        fetch(serviceUrl, request)
          .then(async (response) => {
            if (response.ok) {
              return response.json();
            }

            throw new Error(
              `Can't submit - ${response.status}:${response.statusText} ${await response.text()}`
            );
          })
          .then((responseJson) => {

            goToThanksPage();
          })
          .catch((error) => {
            console.error(error);

            openModal();
          });
      }
    </script>
  </body>
</html>
